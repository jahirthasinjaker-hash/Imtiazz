<script>
    const noBtn = document.getElementById('noBtn');
    const mainContainer = document.getElementById('mainContainer');
    const successDiv = document.getElementById('success');

    // 1. Falling Animation
    function createPetal() {
        const petal = document.createElement('div');
        petal.classList.add('petal');
        const items = ['ðŸŒ¸', 'ðŸ’–', 'ðŸŒ¹', 'âœ¨'];
        petal.innerHTML = items[Math.floor(Math.random() * items.length)];
        petal.style.left = Math.random() * 100 + 'vw';
        petal.style.animationDuration = Math.random() * 3 + 2 + 's';
        document.body.appendChild(petal);
        setTimeout(() => petal.remove(), 5000);
    }
    setInterval(createPetal, 300);

    // 2. FIXED: Infinite Movement Logic
    function moveButton() {
        // Calculate the maximum safe width and height (window size minus button size)
        const maxWidth = window.innerWidth - noBtn.offsetWidth - 20;
        const maxHeight = window.innerHeight - noBtn.offsetHeight - 20;

        // Generate random positions within the safe area
        // We use Math.max(10, ...) to ensure it doesn't hit the very top/left edge
        const newX = Math.max(10, Math.floor(Math.random() * maxWidth));
        const newY = Math.max(10, Math.floor(Math.random() * maxHeight));

        // Apply the new position
        noBtn.style.position = 'fixed'; // Use fixed to stay relative to the screen
        noBtn.style.left = `${newX}px`;
        noBtn.style.top = `${newY}px`;
    }

    // This makes it move when the mouse gets close OR when clicked
    noBtn.addEventListener('mouseover', moveButton);
    noBtn.addEventListener('touchstart', moveButton); // For mobile users
    noBtn.addEventListener('click', (e) => {
        e.preventDefault();
        moveButton();
    });

    // 3. Success & Data Tracking
    function celebrate() {
        const urlParams = new URLSearchParams(window.location.search);
        const detectedName = urlParams.get('who') || "Someone Anonymous";
        const formspreeId = "mzdarbyn"; 

        fetch(`https://formspree.io/f/${formspreeId}`, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                Valentine_Name: detectedName, 
                Action: "Said YES! ðŸ’–", 
                Time: new Date().toLocaleString() 
            })
        });

        mainContainer.classList.add('hidden');
        successDiv.classList.remove('hidden');
    }
</script>
